var data = {};

(function() {

    data = party({
        speeches:[
        "AL GREEN: Wordcloud\n"
            , "RAY ATTRILL: (26 September 2017) FX STRATEGY Thematic The Bond plot thickens China's Bond Connect is an integral platform for an increase in foreign ownership of Chinese debt. In the medium term, the scope for inflows north of US$2.5 trillion into China's debt market should not be discounted. China appears to be well positioned to deepen and broaden its local bond market; alignment of several key success factors will help to realize the potential. Increased demand for CNY as a reserve asset has minimal implications for AUD. The suggestions AUD FX reserves are held in part as a 'China proxy' is misplaced. China's bond connect has kicked off in July 2017 and thus far, there have been encouraging signs. It is currently a pilot scheme connecting HK and China and confined to northbound access for now. While it is not the first and only avenue for foreign investors to invest in China's bond market, it is definitely a more investor friendly channel and likely to be a more efficient framework for China to deepen and broaden its fixed income market in the long run. As the scheme expands beyond current northbound investment in the near future, China will likely see an influx of buyers for its debt as well. Several factors are seen underpinning foreign investors' appetite and these include: Potential inclusion of Chinese bonds into global bond indexes\nIn this report, we focus our estimates on the demand from foreign central banks, which we expect to increase steadily over the medium term. Given the sheer size of China's domestic bond market, the impact on China's financial markets can be very meaningful in the medium term. The total onshore bonds held by foreign institutions stood at RMB841.5bn at the end of July, equivalent to only 1.77 percent of the interbank market, registered at the China Central Depository & Clearing Co., Ltd. (CCDC), but already 8 percent up from RMB778.85bn at the end of 2016. Making further connection, the bulk of these investors are foreign central banks. According to SAFE data, as of end2016, foreign central banks held RMB563.5 billion worth of yuan assets  92 percent in debt securities, with equities and investment funds making up 7.4 percent. Chart 1: Safe CGBs and PBBs account for most of the foreign interest\nTrillion dollar question: How much inflows can be expected? The early success of the HKChina Bond Connect points an encouraging future. In the first month of the launch rd since July 3 , foreign investors bought a net RMB37.8bn worth of Chinese bonds, accounting for more than half of the total foreign investments in the first seven months of this year (RMB62.6bn). However, the focus of interest has been on shortterm papers with tenors less than one year such as commercial papers, usually in the names of super shortterm bills or shortterm bills, and certificates of deposits, according to the Shanghai Clearing House. With this initial information, we estimated the potential bond market inflows based on regional central banks' FX reserves (assuming that they will increase the RMB component in their coffers given that the currency is now a member of the SDR basket), and foreign institutional investors' potential demand. We relied on modelling done by the Asian Development Bank Institute (ADBI). The ADBI found that using only quantitative economic predictors, the projected RMB share could go as high as 12 percent of global reserves. Adding institutional and market measures reduced the predicted share to around 2 percent, which the ADBI felt was 'more realistic'. However, we would note that this was based on 2011 data and published in 2014; since then, China has made huge strides towards an environment that the ADBI recommended. From 5 models that the ADBI had used, we selected one that reasonably represents current conditions, and another one that would be appropriate after full capital liberalization (targeted for 2020). The respective RMB shares projected by these two models are 6.8 percent and 10 percent. In the near term, we could be looking at inflows north of $1 trillion but in the medium term, inflows of more than $2.5 trillion would not be beyond the pale. Prominence in trade and cross border capital flows The Yuan has become increasingly prominent in crossborder capital flows in recent years. It made up 4 percent of global foreign exchange trading last year, and 1.9 percent of global payments in February, according to official data. Growing RMB crossborder flows means that FX reserve managers will need to match that in the distribution of the reserves that they hold. This then in turn generates demand for yield bearing RMB assets. As of March 2015, 62.9 percent of global central bank reserves, or US$3.826 trillion, were in U.S. dollars. Euro reserves, worth US$1.351 trillion, represented 22.2 percent of the total. Japanese Yen took a 3.9 percent share with US$241.2 billion held by central banks, and US$116.2 billion worth of Canadian dollars were held by central banks. Key success factors The Bond Connect scheme eliminates most of the impediments to investing in China's bond market that have in the past been responsible for the low foreign participation. The China InterBank Market (CIBM) was relatively closed to foreign investors prior to 2015. Back then, investing in China's debt market required application for a Qualified Foreign Institutional Investors (QFII) license. Even then, QFIIs were subjected to investment quotas and could only invest in exchange traded bonds. The approval process for participating in\nthe market was lengthy and complex. Furthermore, foreign investors were more interested in A and Hshares trading in China and Hong Kong, due to the large spreads between the two indexes. Low demand for QFII and RQFII products was reflected in the low utilisation rate of the allocated quota for QFIIs and RQFIIs. The total investment quota of QFIIs allotted as of the end of August 2016 was just USD81.5 billion, little more than half the USD150 billion in July 2013. The RMB's fortunes, or misfortunes rather, was another speed bump. The RMB's appreciating trend ended in 2014 and USD/CNY climbed from 6.05 to nearly touch 7.0 in late 2016. In addition, the Chinese financial authorities have shown commitment to the success of this scheme. To facilitate the acclimation to the vagaries of the Bond Connect, the authorities have encouraged state linked entities to issue bonds/bills specifically for Bond Connect. Among others, policy lenders Agricultural Development Bank of China and China Development, held their first ever public tenders simultaneously to both onshore and offshore investors on the launch day of the scheme. The two were followed by a long list of stateowned enterprises such as Huaneng, Guodian, Chalco, China Unicom and Three Gorges, etc. to issue Bond Connect shortterm bills. Lately, the issuer base has been expanded to include local government linked enterprises such as Luzhou Laojian. After the admission of China's Ashares into the MSCI Emerging Markets Index, the conviction for Chinese bonds to be included in several global bond indexes rose perceivably. The bond connect may be a reinforcing factor and in return, the recognition as a global player will make Chinese debt more attractive to foreign investors. While the MSCI Emerging Markets Index is tracked by US$1.6 trillion worth of funds, industry estimates place the three major bond indexes combined in the vicinity of US$4 trillion. These are the JPMorgan's Government Bond Index, Barclays Global Aggregate Index and Citibank's World Government Bond Index. In fact, there has been some notable progress along the line of including China into some bond indexes. In March 2017, Citigroup decided to include onshore Chinese bonds in its three government bond indexes—the Emerging Markets Government Bond Index, the Asian Government Bond Index, and the Asia Pacific Government Bond Index. In addition, Bloomberg has launched two fixed income indexes with RMBdenominated Chinese bonds. Initial estimates were that inflows into these bond indexes once Chinese bonds get included could exceed US$200bn. The bond connect plays an integral part in the RMB internationalisation process. Combined with RMB stability, the availability and accessibility of RMBdenominated assets is the next step forward for the currency to be recognised further as an international currency, after its entry into the IMF SDR basket. Sovereign ratings downgrade unlikely an impediment On 22 September, S&P downgraded China's longterm sovereign rating from AA to A+, bringing it in line with Moody's downgrade in May 2017. By and large, the main concerns were similar to what Moody's had listed. These were namely that loan growth is still continuing at too strong a pace, and that Local Government Financing Vehicle (LGFV) poses a huge worry.\nThe Chinese government disputes this reading, essentially claiming that S&P has glossed over important nuances. The market seems to agree with the government, hardly reacting to the downgrade. One reason for this is that the downgrade merely moves China to the fifth of the 11rung Investment Grade block. We concur with the view that the downgrades will not be a big impediment to the bond connect, nor will it raise funding costs materially as China's bond yields are already the highest among the other A1 graded debt. China's A1/A+ rating is shared with Japan (10Y JGB 0.021 percent), Israel (10Y yield 1.72 percent), Saudi Arabia (10Y USD bond 3.5 percent). Market commentary has turned somewhat more positive recently as the deleveraging efforts have started to look more authentic and the government is appearing to be quite disinclined to bail out borrowers. Foreign investors are unlikely to be spooked by the downgrade since the issues raised have been around for some time and the general opinion is that the government is on the right path, even if proceeding down it rather gingerly. Relevance for Australia The RBA has invested a portion of Australia's foreign exchange reserves in RMB since 2013. The plans revealed then were to invest around 5 percent of its FX reserves in China. The number looked conservative relative to the extent of trade relation between Australia and China then, and probably reflected the hurdle from the lack of capital account liberalisation. However, the bond connect is the game changer and now allows an acceleration of reserve diversification efforts into CNY assets.\n26 September 2017. What is a Bond Connect? The Bond Connect is a scheme that entails mutual market access to China and overseas bond markets, in activities involving trading, custody and settlement. On 3 July 2017, China launched the HKChina Bond Connect Programme and in the initial phase, only allows northbound trading. This marks the fourth bond market programme that enables crossborder trading following the China Interbank Bond Market (CIBM) direct access scheme, the Qualified Foreign Institutional Investor (QFII) and the Renminbi Qualified Foreign Institutional Investor (RQFII) schemes. There is no quota for northbound investment and southbound trading will start at a later date. Eligible investors are mainly institutions, such as banks, insurance companies, brokerages and asset management firms. The establishment of the Bond Connect replaces the previous mode of access whereby foreign investors have to go through lengthy process of opening a QFII account, CNY quotas application and then finding a clearing agent with international settlement capabilities. With the Bond Connect, foreign investors can trade directly in China's bond market through the Hong Kong exchange.\nPerhaps the bigger question – relevant for the AUD – is whether increased demand for CNY and CNY assets by reserve managers could see reduced demand for AUD as a reserve asset? It is often suggested that the AUD may be being held by reserve managers in part as a 'China proxy' given the strong trade links between Australia and China. We've highly sceptical here. The increased use of AUD as a reserve asset since the Global Financial Crisis has been part of a generalised desire to diversify away from the US dollar (and the Euro during the various Eurozone crises since 2011). The fact that holdings of Canadian dollars have risen by as much as for Australian dollars (in both case to just under 2 percent of holdings) and given the more tenuous direct trade links between Canada and China, suggest that the 'China proxy' argument for AUD holdings is largely illusory. As of Q1 2017, reserve managers who divulge their allocations to the IMF hold on average 1.84 percent in AUD and 1.93 percent in CAD (in both cases just more than 0.1 percent higher than a year earlier). There's no evidence here then the AUD enjoys favouritism over CAD, and as such little or no reason to think global reserve managers will materially reduce AUD holdings in conjunction with any diversification towards CNY, beyond any generalised diversification towards CNY and away from other currencies over the medium/longer term."
        ]

    });

    data.speakers = {
        "AL GREEN": {
            name: "Al Green",
            title: "U.S. representative, Texas"
        },

        
            "OBAMA": {
                name: "OBAMA",
                title: "NA"
            },
    


        "XAVIER BECERRA": {
            name: "Xavier Becerra",
            title: "U.S. representative, California"
        }
    };

    data.topics = [{

        name: "Affordable",
        re: /\b(afford[a-z]*)\b/gi,
        x: 458,
        y: 316
        }, {
            name: "China",
            re: /\b(china)\b/gi,
            x: 99,
            y: 297
            
    }, {
            name: "percent",
            re: /\b(percent)\b/gi,
            x: 358,
            y: 738
            
    }, {
            name: "bond",
            re: /\b(bond)\b/gi,
            x: 357,
            y: 125
            
    }, {
            name: "Bond Connect",
            re: /\b(bond connect)\b/gi,
            x: 356,
            y: 370
            
    }, {
            name: "foreign",
            re: /\b(foreign)\b/gi,
            x: 80,
            y: 763
            
    }, {
            name: "market",
            re: /\b(market)\b/gi,
            x: 369,
            y: 413
            
    }, {
            name: "Government",
            re: /\b(government)\b/gi,
            x: 166,
            y: 659
            
    }, {
            name: "global",
            re: /\b(global)\b/gi,
            x: 719,
            y: 238
            
    }, {
            name: "AUD",
            re: /\b(aud)\b/gi,
            x: 306,
            y: 305
            
    }, {
            name: "RMB",
            re: /\b(rmb)\b/gi,
            x: 621,
            y: 614
            
    }, {
            name: "Chinese",
            re: /\b(chinese)\b/gi,
            x: 548,
            y: 210
            
    }, {
            name: "asset",
            re: /\b(asset)\b/gi,
            x: 41,
            y: 58
            
    }, {
            name: "bond market",
            re: /\b(bond market)\b/gi,
            x: 49,
            y: 591
            
    }, {
            name: "Index",
            re: /\b(index)\b/gi,
            x: 361,
            y: 41
            
    }, {
            name: "scheme",
            re: /\b(scheme)\b/gi,
            x: 168,
            y: 697
            
    }, {
            name: "reserve",
            re: /\b(reserve)\b/gi,
            x: 181,
            y: 227
            

//    }, {
//        name: "American dream",
//        re: /\b(american dream)\b/gi,
//        x: 412,
//        y: 287
//    }, {
//        name: "Housing",
//        re: /\b(Housing|houses|property)\b/gi,
//        x: 607,
//        y: 211
//    }, {
//        name: "Equities",
//        re: /\b(equity|equities)\b/gi,
//        x: 280,
//        y: 394
//    }, {
//        name: "Biden",
//        re: /\b(biden)\b/gi,
//        x: 507,
//        y: 307
//    }, {
//        name: "bin Laden",
//        re: /\b(osama|bin laden)\b/gi,
//        x: 392,
//        y: 246
//    }, {
//        name: "Business",
//        re: /\b(business[a-z]*)\b/gi,
//        x: 677,
//        y: 127
//    }, {
//        name: "GBP",
//        re: /\b(GBP)\b/gi,
//        x: 414,
//        y: 118
//    }, {
//        name: "Income",
//        re: /\b(income(?:s)?)\b/gi,
//        x: 677,
//        y: 257
//    }, {
//        name: "Slowing",
//        re: /\b(slow|slowing|slowdown)\b/gi,
//        x: 345,
//        y: 120
//    }, {
//        name: "Economy",
//        re: /\b(econom[a-z]+)\b/gi,
//        x: 474,
//        y: 389
//    }, {
//        name: "USD",
//        re: /\b(USD)\b/gi,
//        x: 340,
//        y: 227
//    }, {
//        name: "Energy",
//        re: /\b(energy)\b/gi,
//        x: 598,
//        y: 309
//    }, {
//        name: "NZD",
//        re: /\b(nzd)\b/gi,
//        x: 643,
//        y: 316
//    }, {
//        name: "Bill",
//        re: /\b(bill)\b/gi,
//        x: 549,
//        y: 289
//    }, {
//        name: "Losses",
//        re: /\b(losses|loss)\b/gi,
//        x: 178,
//        y: 339
//    }, {
//        name: "EUR",
//        re: /\b(nzd)\b/gi,
//        x: 742,
//        y: 170
//    }, {
//        name: "Commodities",
//        re: /\b(commodity|commodities)\b/gi,
//        x: 616,
//        y: 373
//    }, {
//        name: "Metal",
//        re: /\b(metal)\b/gi,
//        x: 526,
//        y: 118
//    }, {
//        name: "CNY",
//        re: /\b(CNY|CNH)\b/gi,
//        x: 726,
//        y: 292
//    }, {
//        name: "Rate",
//        re: /\b(rate|rates)\b/gi,
//        x: 623,
//        y: 169
//    }, {
//        name: "BRI",
//        re: /\b(bri)\b/gi,
//        x: 202,
//        y: 252
//    }, {
//        name: "Invest",
//        re: /\b(invest(?:ment|ments|ing)?)\b/gi,
//        x: 587,
//        y: 251
//    }, {
//        name: "Jobs",
//        re: /\b(job[a-z]*)\b/gi,
//        x: 234,
//        y: 117
////    }, {
////        name: "Leadership",
////        re: /\b(leader[a-z]*)\b/gi,
////        x: 546,
////        y: 350
////    }, {
////        name: "Level playing field",
////        re: /\b(level(?: the)? playing field)\b/gi,
////        x: 580,
////        y: 207
//    }, {
//        name: "Price",
//        re: /\b(price|prices)\b/gi,
//        x: 376,
//        y: 168
//    }, {
//        name: "States",
//        re: /\b(state|states)\b/gi,
//        x: 789,
//        y: 239
//    }, {
//        name: "Bank",
//        re: /\b(bank(?:s)?)\b/gi,
//        x: 235,
//        y: 301
//    }, {
//        name: "Labor",
//        re: /\b(labor|ALP)\b/gi,
//        x: 670,
//        y: 296
////    }, {
////        name: "Obama",
////        re: /\b(obama)\b/gi,
////        x: 484,
////        y: 206
////    }, {
////        name: "Obamacare",
////        re: /\b(obamacare)\b/gi,
////        x: 577,
////        y: 178
//    }, {
//        name: "Oil / Gas",
//        re: /\b(oil|gas|petrol)\b/gi,
//        x: 637,
//        y: 275
//    }, {
//        name: "Interest",
//        re: /\b(interest|interests)\b/gi,
//        x: 405,
//        y: 348
//    }, {
//        name: "House",
//        re: /\b(house(?:s)?)\b/gi,
//        x: 388,
//        y: 213
//    }, {
//        name: "Market",
//        re: /\b(market(?:s)?)\b/gi,
//        x: 716,
//        y: 229
//    }, {
//        name: "Royalty",
//        re: /\b(royalty|royalties)\b/gi,
//        x: 285,
//        y: 307
//    }, {
//        name: "FX",
//        re: /\b(fx)\b/gi,
//        x: 311,
//        y: 165
//    }, {
//        name: "Seniors",
//        re: /\b(seniors)\b/gi,
//        x: 367,
//        y: 307
//    }, {
//        name: "Tax",
//        re: /\b(tax[a-z]*)\b/gi,
//        x: 161,
//        y: 184
//    }, {
//        name: "China",
//        re: /\b(china)\b/gi,
//        x: 344,
//        y: 384
//    }, {
//        name: "Debt",
//        re: /\b(debt|debts)\b/gi,
//        x: 640,
//        y: 230
//    }, {
//        name: "Values",
//        re: /\b(value[a-z]*)\b/gi,
//        x: 572,
//        y: 132
//    }, {
//        name: "Vote",
//        re: /\b(vote|voter|voters|voting)\b/gi,
//        x: 266,
//        y: 214
//    }, {
//        name: "Liberal",
//        re: /\b(liberal|liberals)\b/gi,
//        x: 368,
//        y: 270
////    }, {
////        name: "War",
////        re: /\b(war(?:s)?)\b/gi,
////        x: 676,
////        y: 193
//    }, {
//        name: "Bond",
//        re: /\b(bond(?:s)?)\b/gi,
//        x: 674,
//        y: 191
//    }, {
//        name: "Reserve",
//        re: /\b(reserve(?:s)?)\b/gi,
//        x: 674,
//        y: 181
//    }, {
//        name: "AUD",
//        re: /\baud\b/gi,
//        x: 111,
//        y: 261
    }, {
        name: "Business",
        re: /\b(business[a-z]*)\b/gi,
        x: 333,
        y: 888
    }].map(topic);

    data.topic = function(name) {
        var t = topic({
            name: name,
            re: new RegExp("\\b(" + d3.requote(name) + ")\\b","gi")
        });
        data.topics.push(t);
        return t;
    }
    ;

    function party(party) {
        party.speeches = party.speeches.map(speech);
        party.sections = sections(party.speeches);
        return party;
    }

    function speech(text, i) {
        return {
            text: text,
            id: i
        };
    }

    function sections(speeches) {
        var speakerRe = /(?:\n|^)([A-Z\.()\- ]+): /g
          , sections = [];

        speeches.forEach(function(speech) {
            var speakerName = "AUDIENCE", match, i = speakerRe.lastIndex = 0;
            while (match = speakerRe.exec(speech.text)) {
                if (match.index > i)
                    sections.push({
                        speaker: speakerName,
                        speech: speech,
                        i: i,
                        j: match.index
                    });
                speakerName = match[1];
                i = speakerRe.lastIndex;
            }
            sections.push({
                speaker: speakerName,
                speech: speech,
                i: i,
                j: speech.text.length
            });
        });

        return sections.filter(function(d) {
            return !/^AUDIENCE\b/.test(d.speaker);
        });
    }

    function topic(topic) {
        topic.count = 0;
        topic.mentions = [];

        data.sections.forEach(function(section) {
            var text = section.speech.text.substring(section.i, section.j), match;
            topic.re.lastIndex = 0;
            while (match = topic.re.exec(text)) {
                ++topic.count;
                topic.mentions.push({
                    topic: topic,
                    section: section,
                    i: section.i + match.index,
                    j: section.i + topic.re.lastIndex
                });
            }
        });

        return topic;
    }

}
)();

(function() {

    var width = 970
      , height = 500;

    var padding = 4, // collision padding
    maxRadius = 80, // collision search radius
    maxMentions = 100, // limit displayed mentions
    activeTopic;
    // currently-displayed topic

    var r = d3.scale.sqrt().domain([0, d3.max(data.topics, function(d) {
        return d.count;
    })]).range([0, maxRadius]);

    var force = d3.layout.force().gravity(0).charge(0).size([width, height]).on("tick", tick);

    var node = d3.select(".g-nodes").selectAll(".g-node")
      , label = d3.select(".g-labels").selectAll(".g-label");

    d3.select(".g-nodes").append("rect").attr("class", "g-overlay").attr("width", width).attr("height", height).on("click", clear);

    d3.select(window).on("hashchange", hashchange);

    d3.select("#g-form").on("submit", submit);

    updateTopics(data.topics);
    hashchange();

    // Update the known topics.
    function updateTopics(topics) {
        topics.forEach(function(d, i) {
            d.r = Math.max(12, r(d.count));
        });
        // min. collision
        force.nodes(data.topics = topics).start();
        updateNodes();
        updateLabels();
    }

    // Update the displayed nodes.
    function updateNodes() {
        node = node.data(data.topics, function(d) {
            return d.name;
        });

        node.exit().remove();

        node.enter().append("a").attr("class", "g-node").attr("xlink:href", function(d) {
            return "#" + encodeURIComponent(d.name);
        }).call(force.drag).call(linkTopic).append("circle");

        node.select("circle").attr("r", function(d) {
            return r(d.count);
        });
    }

    // Update the displayed node labels.
    function updateLabels() {
        label = label.data(data.topics, function(d) {
            return d.name;
        });

        label.exit().remove();

        var labelEnter = label.enter().append("a").attr("class", "g-label").attr("href", function(d) {
            return "#" + encodeURIComponent(d.name);
        }).call(force.drag).call(linkTopic);

        labelEnter.append("div").attr("class", "g-name").text(function(d) {
            return d.name;
        });

        labelEnter.append("div").attr("class", "g-value");

        label.style("font-size", function(d) {
            return Math.max(8, r(d.count) / 2) + "px";
        }).style("width", function(d) {
            return r(d.count) * 2.5 + "px";
        });

        // Create a temporary span to compute the true text width.
        label.append("span").text(function(d) {
            return d.name;
        }).each(function(d) {
            d.dx = Math.max(2.5 * r(d.count), this.getBoundingClientRect().width);
        }).remove();

        label.style("width", function(d) {
            return d.dx + "px";
        }).select(".g-value").text(function(d) {
            return d.count + (d.r > 60 ? " mentions" : "");
        });

        // Compute the height of labels when wrapped.
        label.each(function(d) {
            d.dy = this.getBoundingClientRect().height;
        });
    }

    // Update the active topic.
    function updateActiveTopic(topic) {
        if (activeTopic = topic) {
            node.classed("g-selected", function(d) {
                return d === topic;
            });
            updateMentions(findMentions(topic));
            d3.select("#g-topic").text((topic.count > maxMentions ? "A sampling of " : topic.count || "No") + " mentions of “" + topic.name + "” in the quoted articles");
        } else {
            node.classed("g-selected", false);
            updateMentions(sampleMentions());
            d3.select("#g-topic").text("A sampling of excerpts from the articles");
        }
    }

    // Update displayed excerpts.
    function updateMentions(mentions) {

        // Rather than compute a data-join, just blow away the entire layout.
        // With wider support for multi-column layout, a data-join would work.
        var column = d3.selectAll(".g-mentions").datum(0).html(null);

        var heights = column.data()
          , indexes = d3.range(heights.length)
          , speakers = groupMentionsBySpeaker(mentions);

        speakers.sort(function(a, b) {
            return b.values.length - a.values.length;
        });

        // Incrementally add each new speaker to the shortest column.
        speakers.forEach(function(d) {
            var index = d3.first(indexes, function(a, b) {
                return heights[a] - heights[b];
            })
              , speakerName = d.values[0].section.speaker
              , speaker = data.speakers[speakerName];

            var div = d3.select(column[0][index]).append("div").attr("class", "g-mention");

            div.append("div").attr("class", "g-speaker").text(speaker ? speaker.name : speakerName);

            div.append("div").attr("class", "g-speaker-title").text(speaker ? speaker.title : "");

            var p = div.selectAll("p").data(d.values).enter().append("p").html(function(d) {
                return d.section.speech.text.substring(d.start, d.end).replace(d.topic.re, "<a>$1</a>");
            });

            if (activeTopic) {
                p.attr("class", "g-hover");
            } else {
                p.each(function(d) {
                    d3.select(this).selectAll("a").datum(d.topic).attr("href", "#" + encodeURIComponent(d.topic.name)).call(linkTopic);
                });
            }

            heights[index] += div.node().getBoundingClientRect().height;
        });
    }

    // Return a random sample of mentions, one per topic.
    // Mentions are returned in chronological order.
    function sampleMentions() {
        return data.topics.filter(function(d) {
            return d.mentions.length;
        }).map(function(d) {
            return d.mentions[Math.floor(Math.random() * d.mentions.length)];
        }).sort(orderMentions);
    }

    // Return displayable mentions for the specified topic.
    // If too many, a random sample of matching mentions is returned.
    // Mentions are returned in chronological order.
    function findMentions(topic) {
        var mentions = topic.mentions;
        if (mentions.length > maxMentions) {
            shuffle(mentions).length = maxMentions;
            mentions.sort(orderMentions);
        }
        return mentions;
    }

    // Group mentions by speaker, collapse overlapping excerpts.
    function groupMentionsBySpeaker(mentions) {
        return d3.nest().key(function(d) {
            return d.section.speaker;
        }).rollup(collapseMentions).entries(mentions);
    }

    // Given an array of mentions, computes the start and end point of the context
    // excerpt, and then collapses any overlapping excerpts.
    function collapseMentions(mentions) {
        var sentenceRe = /([!?.)]+)\s+/g, // sentence splitting requires NLP
        i, n = mentions.length, d0, d1;

        // First compute the excerpt contexts.
        for (i = 0; i < n; ++i) {
            d0 = mentions[i];
            d0.start = excerptStart(d0);
            d0.end = excerptEnd(d0);
        }

        // Then collapse any overlapping excerpts (from the same speech).
        for (i = 1,
        d1 = mentions[0]; i < n; ++i) {
            d0 = d1;
            d1 = mentions[i];
            if (d1.section.speech.id === d0.section.speech.id && d1.start >= d0.start && d1.start < d0.end) {
                d1.start = -1;
                d0.end = d1.end;
                d1 = d0;
            }
        }

        // Returns the start index of the excerpt for the specified mention.
        function excerptStart(mention) {
            var i = sentenceRe.lastIndex = Math.max(mention.section.i, mention.i - 80), match;
            while (match = sentenceRe.exec(mention.section.speech.text)) {
                if (match.index < mention.i - 20)
                    return match.index + match[0].length;
                if (i <= mention.section.i)
                    break;
                sentenceRe.lastIndex = i = Math.max(mention.section.i, i - 20);
            }
            return mention.section.i;
        }

        // Returns the end index of the excerpt for the specified mention.
        function excerptEnd(mention) {
            var i = mention.section.j, match;
            sentenceRe.lastIndex = mention.j + 40;
            match = sentenceRe.exec(mention.section.speech.text);
            return match ? Math.min(match.index + match[1].length, i) : i;
        }

        return mentions.filter(function(d) {
            return d.start >= 0;
        });
    }

    // Orders mentions chronologically: by speech and position within speech.
    function orderMentions(a, b) {
        return a.section.speech.id - b.section.speech.id || a.i - b.i;
    }

    // Assign event handlers to topic links.
    function linkTopic(a) {
        a.on("click", click).on("mouseover", mouseover).on("mouseout", mouseout);
    }

    // Returns the topic matching the specified name, approximately.
    // If no matching topic is found, returns undefined.
    function findTopic(name) {
        for (var i = 0, n = data.topics.length, t; i < n; ++i) {
            if ((t = data.topics[i]).name === name || new RegExp("^" + (t = data.topics[i]).re.source + "$","i").test(name)) {
                return t;
            }
        }
    }

    // Returns the topic matching the specified name, approximately.
    // If no matching topic is found, a new one is created.
    function findOrAddTopic(name) {
        var topic = findTopic(name);
        if (!topic) {
            topic = data.topic(name.substring(0, 1).toUpperCase() + name.substring(1));
            topic.x = width - 40;
            topic.y = 0;
            updateTopics(data.topics);
        }
        return topic;
    }

    // Simulate forces and update node and label positions on tick.
    function tick(e) {
        node.each(gravity(e.alpha * .1)).each(collide(.5)).attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        });

        label.style("left", function(d) {
            return (d.x - d.dx / 2) + "px";
        }).style("top", function(d) {
            return (d.y - d.dy / 2) + "px";
        });
    }

    // Custom gravity to favor a non-square aspect ratio.
    function gravity(alpha) {
        var cx = width / 2
          , cy = height / 2
          , ax = alpha / 4
          , ay = alpha;
        return function(d) {
            d.x += (cx - d.x) * ax;
            d.y += (cy - d.y) * ay;
        }
        ;
    }

    // Resolve collisions between nodes.
    function collide(alpha) {
        var q = d3.geom.quadtree(data.topics);
        return function(d) {
            var r = d.r + maxRadius + padding
              , nx1 = d.x - r
              , nx2 = d.x + r
              , ny1 = d.y - r
              , ny2 = d.y + r;
            q.visit(function(quad, x1, y1, x2, y2) {
                if (quad.point && (quad.point !== d) && d.other !== quad.point && d !== quad.point.other) {
                    var x = d.x - quad.point.x
                      , y = d.y - quad.point.y
                      , l = Math.sqrt(x * x + y * y)
                      , r = d.r + quad.point.r + padding;
                    if (l < r) {
                        l = (l - r) / l * alpha;
                        d.x -= x *= l;
                        d.y -= y *= l;
                        quad.point.x += x;
                        quad.point.y += y;
                    }
                }
                return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
            });
        }
        ;
    }

    // Fisher–Yates shuffle.
    function shuffle(array) {
        var m = array.length, t, i;
        while (m) {
            i = Math.floor(Math.random() * m--);
            t = array[m];
            array[m] = array[i];
            array[i] = t;
        }
        return array;
    }

    // Update the active topic on hashchange, perhaps creating a new topic.
    function hashchange() {
        var name = decodeURIComponent(location.hash.substring(1)).trim();
        updateActiveTopic(name && name != "!" ? findOrAddTopic(name) : null);
    }

    // Trigger a hashchange on submit.
    function submit() {
        var name = this.search.value.trim();
        location.hash = name ? encodeURIComponent(name) : "!";
        this.search.value = "";
        d3.event.preventDefault();
    }

    // Clear the active topic when clicking on the chart background.
    function clear() {
        location.replace("#!");
    }

    // Rather than flood the browser history, use location.replace.
    function click(d) {
        location.replace("#" + encodeURIComponent(d === activeTopic ? "!" : d.name));
        d3.event.preventDefault();
    }

    // When hovering the label, highlight the associated node and vice versa.
    // When no topic is active, also cross-highlight with any mentions in excerpts.
    function mouseover(d) {
        node.classed("g-hover", function(p) {
            return p === d;
        });
        if (!activeTopic)
            d3.selectAll(".g-mention p").classed("g-hover", function(p) {
                return p.topic === d;
            });
    }

    // When hovering the label, highlight the associated node and vice versa.
    // When no topic is active, also cross-highlight with any mentions in excerpts.
    function mouseout(d) {
        node.classed("g-hover", false);
        if (!activeTopic)
            d3.selectAll(".g-mention p").classed("g-hover", false);
    }

}
)();
